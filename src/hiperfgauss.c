/** Copyright 2016 Ian W. Larson
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


#include "hiperfgauss.h"

#include <float.h>
#include <math.h>

#include <stdbool.h>
#include <stdint.h>

#ifndef M_PI
#define M_PI 3.14159265358979323846
#endif /* M_PI */

#ifndef M_SQRTPI2
#define M_SQRTPI2 0.886226925452758013649083741670
#endif

#define INV_UINT32_MAX 1.0/UINT32_MAX

#ifndef M_SQRT2
#define M_SQRT2 1.41421356237309504880
#endif

float erf_constants[] = {
    0.8862269254527579, 0.23201366653465444, 0.1275561753055979, 0.08655212924154748, 0.06495961774538538, 0.05173128198461632,
    0.042836720651797305, 0.036465929308531576, 0.03168900502160539, 0.02798063296499518, 0.025022275841198302,
    0.022609863318897524, 0.020606780379058956, 0.018918217250778812, 0.017476370562856502, 0.016231500987685204,
    0.015146315063247762, 0.014192316002509918, 0.013347364197421252, 0.012594004871332025, 0.01191829593639199,
    0.011308970105922495, 0.010756825303317914, 0.010254274081853424, 0.009795005770071136, 0.00937372981918204,
    0.00898597850284334, 0.008627953580709396, 0.0082964059277392, 0.007988540162603317, 0.007701938432259726,
    0.007434499017831495, 0.00718438651126827, 0.006949991101064672, 0.006729895085341489, 0.006522845161450022,
    0.006327729364343104, 0.006143557770384117, 0.005969446269734419, 0.005804602853834262, 0.0056483159755515225,
    0.005499944626203927, 0.005358909841686407, 0.005224687403687449, 0.0050968015447061645, 0.004974819499738999,
    0.004858346774958446, 0.004747023025884935, 0.00464051845555899, 0.004538530657907046
};

static inline float erfinv(float a, int extent)
{
    float out = 0;
    const float a_sqrd = a*a;
    for (int m = 0; m < extent; ++m) {
        out += erf_constants[m]*a;
        a *= a_sqrd;
    }

    return out;
}

static inline float inv_xform_float(uint32_t val, float stddev)
{
    return stddev*M_SQRT2*erfinv(2.0*val*INV_UINT32_MAX - 1, 18);
}

static inline float accept_reject_float(hpg_state *st)
{
    // Lets try using a PDF g(x) = 1/2 * exp(-x^2 / 2)
    // normal PDF is f(x) = 1/ (sig*sqrt(2*pi)) * exp(-1/2 * (x/sig)**2)
    float x;
    uint32_t c = 0;
    for (;;) {
        if (st->counter + 3 >= STATE_BUFFER_SIZE) {
            st->rng->bytes((uint8_t *)st->internal_rand_buffer, sizeof(st->internal_rand_buffer), st->rng->state);
            st->counter = 0;
        }
        uint32_t a = st->internal_rand_buffer[st->counter++];
        uint32_t b = st->internal_rand_buffer[st->counter++];
        if (!c) {
            c = st->internal_rand_buffer[st->counter++];
        }
        x = -logf(a * INV_UINT32_MAX);
        if (b * INV_UINT32_MAX <= expf(-1*(x - 1)*(x - 1) / 2)) {
            if (c & 0x1) {
                x *= -1;
            }
            c >>= 1;
            break;
        }
    }

    return x*st->stddev;
}

static inline float box_muller_float(hpg_state *st)
{
    static float z0, z1;
    float u1, u2;
    static bool leftover;
    leftover = !leftover;
    if (!leftover) {
        return z1;
    }

    for (;;) {
        if (st->counter + 2 >= STATE_BUFFER_SIZE) {
            st->rng->bytes((uint8_t *)st->internal_rand_buffer, sizeof(st->internal_rand_buffer), st->rng->state);
            st->counter = 0;
        }
        u1 = st->internal_rand_buffer[st->counter++] * INV_UINT32_MAX;
        u2 = st->internal_rand_buffer[st->counter++] * INV_UINT32_MAX;
        if (u1 <= FLT_MIN) {
            continue;
        } else {
            break;
        }

    }

    z0 = sqrtf(-2.f * logf(u1)) * cosf(2*M_PI*u2) * st->stddev;
    z1 = sqrtf(-2.f * logf(u1)) * sinf(2*M_PI*u2) * st->stddev;
    leftover = true;

    return z0;
}

// Precalculated lookups for the ziggurat method.
static const uint32_t zigg_k[256] = {
    4013152287, 65271128, 3230528557, 3660974613, 3844064872, 3945109355, 4009025002, 4053044132, 4085181003, 4109662460,
    4128926400, 4144476553, 4157290303, 4168030194, 4177161116, 4185018821, 4191851811, 4197847921, 4203151753, 4207876430,
    4212111711, 4215929723, 4219389086, 4222537932, 4225416147, 4228057066, 4230488761, 4232735043, 4234816239, 4236749808,
    4238550827, 4240232386, 4241805902, 4243281382, 4244667631, 4245972428, 4247202672, 4248364500, 4249463395, 4250504265,
    4251491519, 4252429130, 4253320685, 4254169432, 4254978321, 4255750033, 4256487014, 4257191497, 4257865530, 4258510987,
    4259129592, 4259722931, 4260292468, 4260839554, 4261365437, 4261871276, 4262358143, 4262827036, 4263278882, 4263714545,
    4264134830, 4264540490, 4264932225, 4265310694, 4265676513, 4266030258, 4266372472, 4266703662, 4267024308, 4267334859,
    4267635741, 4267927351, 4268210069, 4268484249, 4268750228, 4269008324, 4269258838, 4269502056, 4269738247, 4269967668,
    4270190561, 4270407157, 4270617675, 4270822322, 4271021298, 4271214790, 4271402977, 4271586030, 4271764111, 4271937376,
    4272105971, 4272270039, 4272429712, 4272585120, 4272736385, 4272883623, 4273026947, 4273166463, 4273302274, 4273434476,
    4273563164, 4273688426, 4273810348, 4273929011, 4274044493, 4274156870, 4274266212, 4274372588, 4274476064, 4274576702,
    4274674562, 4274769700, 4274862173, 4274952032, 4275039327, 4275124106, 4275206414, 4275286296, 4275363792, 4275438943,
    4275511785, 4275582355, 4275650686, 4275716812, 4275780763, 4275842567, 4275902253, 4275959846, 4276015371, 4276068851,
    4276120307, 4276169759, 4276217226, 4276262726, 4276306274, 4276347884, 4276387571, 4276425346, 4276461220, 4276495202,
    4276527301, 4276557523, 4276585874, 4276612359, 4276636979, 4276659738, 4276680635, 4276699670, 4276716841, 4276732143,
    4276745573, 4276757124, 4276766788, 4276774557, 4276780420, 4276784365, 4276786379, 4276786447, 4276784552, 4276780677,
    4276774801, 4276766902, 4276756958, 4276744943, 4276730830, 4276714590, 4276696191, 4276675601, 4276652783, 4276627699,
    4276600310, 4276570571, 4276538437, 4276503861, 4276466789, 4276427167, 4276384938, 4276340040, 4276292408, 4276241973,
    4276188662, 4276132397, 4276073096, 4276010673, 4275945036, 4275876087, 4275803722, 4275727832, 4275648301, 4275565005,
    4275477813, 4275386586, 4275291175, 4275191424, 4275087164, 4274978218, 4274864394, 4274745490, 4274621290, 4274491562,
    4274356058, 4274214513, 4274066644, 4273912146, 4273750691, 4273581927, 4273405477, 4273220931, 4273027849, 4272825754,
    4272614130, 4272392417, 4272160008, 4271916241, 4271660395, 4271391683, 4271109242, 4270812128, 4270499301, 4270169616,
    4269821809, 4269454480, 4269066074, 4268654859, 4268218900, 4267756028, 4267263804, 4266739474, 4266179916, 4265581576,
    4264940391, 4264251692, 4263510082, 4262709296, 4261842008, 4260899596, 4259871841, 4258746533, 4257508956, 4256141196,
    4254621221, 4252921598, 4251007718, 4248835240, 4246346374, 4243464274, 4240084369, 4236060408, 4231181054, 4225128489,
    4217400398, 4207150482, 4192825841, 4171211933, 4134297494, 4054164689
};

static const double zigg_w[256] = {
    0.0000000009105443, 0.0000000000501188, 0.0000000000666327, 0.0000000000781718, 0.0000000000873413, 0.0000000000950868,
    0.0000000001018689, 0.0000000001079493, 0.0000000001134928, 0.0000000001186102, 0.0000000001233800, 0.0000000001278601,
    0.0000000001320945, 0.0000000001361174, 0.0000000001399562, 0.0000000001436332, 0.0000000001471664, 0.0000000001505712,
    0.0000000001538603, 0.0000000001570448, 0.0000000001601340, 0.0000000001631361, 0.0000000001660582, 0.0000000001689066,
    0.0000000001716868, 0.0000000001744038, 0.0000000001770620, 0.0000000001796652, 0.0000000001822172, 0.0000000001847210,
    0.0000000001871797, 0.0000000001895959, 0.0000000001919721, 0.0000000001943104, 0.0000000001966130, 0.0000000001988818,
    0.0000000002011184, 0.0000000002033246, 0.0000000002055018, 0.0000000002076515, 0.0000000002097750, 0.0000000002118734,
    0.0000000002139480, 0.0000000002159998, 0.0000000002180298, 0.0000000002200389, 0.0000000002220282, 0.0000000002239983,
    0.0000000002259502, 0.0000000002278845, 0.0000000002298020, 0.0000000002317033, 0.0000000002335892, 0.0000000002354601,
    0.0000000002373168, 0.0000000002391597, 0.0000000002409894, 0.0000000002428064, 0.0000000002446111, 0.0000000002464041,
    0.0000000002481858, 0.0000000002499565, 0.0000000002517168, 0.0000000002534670, 0.0000000002552075, 0.0000000002569386,
    0.0000000002586607, 0.0000000002603741, 0.0000000002620792, 0.0000000002637762, 0.0000000002654655, 0.0000000002671474,
    0.0000000002688222, 0.0000000002704900, 0.0000000002721513, 0.0000000002738062, 0.0000000002754550, 0.0000000002770979,
    0.0000000002787352, 0.0000000002803671, 0.0000000002819939, 0.0000000002836157, 0.0000000002852328, 0.0000000002868454,
    0.0000000002884536, 0.0000000002900577, 0.0000000002916579, 0.0000000002932543, 0.0000000002948472, 0.0000000002964367,
    0.0000000002980230, 0.0000000002996064, 0.0000000003011868, 0.0000000003027646, 0.0000000003043399, 0.0000000003059128,
    0.0000000003074835, 0.0000000003090523, 0.0000000003106191, 0.0000000003121842, 0.0000000003137478, 0.0000000003153100,
    0.0000000003168709, 0.0000000003184307, 0.0000000003199895, 0.0000000003215475, 0.0000000003231048, 0.0000000003246616,
    0.0000000003262180, 0.0000000003277741, 0.0000000003293301, 0.0000000003308861, 0.0000000003324423, 0.0000000003339988,
    0.0000000003355557, 0.0000000003371132, 0.0000000003386714, 0.0000000003402305, 0.0000000003417905, 0.0000000003433517,
    0.0000000003449141, 0.0000000003464779, 0.0000000003480432, 0.0000000003496102, 0.0000000003511790, 0.0000000003527497,
    0.0000000003543225, 0.0000000003558976, 0.0000000003574749, 0.0000000003590548, 0.0000000003606374, 0.0000000003622227,
    0.0000000003638109, 0.0000000003654023, 0.0000000003669968, 0.0000000003685947, 0.0000000003701962, 0.0000000003718013,
    0.0000000003734102, 0.0000000003750232, 0.0000000003766402, 0.0000000003782616, 0.0000000003798874, 0.0000000003815179,
    0.0000000003831531, 0.0000000003847933, 0.0000000003864387, 0.0000000003880893, 0.0000000003897454, 0.0000000003914072,
    0.0000000003930749, 0.0000000003947486, 0.0000000003964285, 0.0000000003981148, 0.0000000003998078, 0.0000000004015076,
    0.0000000004032144, 0.0000000004049285, 0.0000000004066501, 0.0000000004083793, 0.0000000004101165, 0.0000000004118618,
    0.0000000004136155, 0.0000000004153778, 0.0000000004171490, 0.0000000004189294, 0.0000000004207192, 0.0000000004225186,
    0.0000000004243280, 0.0000000004261477, 0.0000000004279779, 0.0000000004298190, 0.0000000004316712, 0.0000000004335349,
    0.0000000004354104, 0.0000000004372981, 0.0000000004391983, 0.0000000004411114, 0.0000000004430378, 0.0000000004449778,
    0.0000000004469319, 0.0000000004489005, 0.0000000004508840, 0.0000000004528828, 0.0000000004548976, 0.0000000004569286,
    0.0000000004589765, 0.0000000004610418, 0.0000000004631249, 0.0000000004652266, 0.0000000004673473, 0.0000000004694877,
    0.0000000004716484, 0.0000000004738301, 0.0000000004760335, 0.0000000004782594, 0.0000000004805084, 0.0000000004827815,
    0.0000000004850794, 0.0000000004874030, 0.0000000004897533, 0.0000000004921312, 0.0000000004945378, 0.0000000004969741,
    0.0000000004994413, 0.0000000005019405, 0.0000000005044731, 0.0000000005070404, 0.0000000005096437, 0.0000000005122847,
    0.0000000005149648, 0.0000000005176858, 0.0000000005204495, 0.0000000005232579, 0.0000000005261128, 0.0000000005290167,
    0.0000000005319717, 0.0000000005349805, 0.0000000005380457, 0.0000000005411702, 0.0000000005443572, 0.0000000005476101,
    0.0000000005509326, 0.0000000005543286, 0.0000000005578025, 0.0000000005613591, 0.0000000005650034, 0.0000000005687414,
    0.0000000005725791, 0.0000000005765237, 0.0000000005805826, 0.0000000005847646, 0.0000000005890791, 0.0000000005935370,
    0.0000000005981503, 0.0000000006029327, 0.0000000006079000, 0.0000000006130703, 0.0000000006184642, 0.0000000006241060,
    0.0000000006300243, 0.0000000006362530, 0.0000000006428324, 0.0000000006498120, 0.0000000006572524, 0.0000000006652295,
    0.0000000006738401, 0.0000000006832106, 0.0000000006935102, 0.0000000007049735, 0.0000000007179394, 0.0000000007329251,
    0.0000000007507799, 0.0000000007730548, 0.0000000008030977, 0.0000000008507988
};

static const float zigg_f[256] = {
    0.398940145769, 0.389805767684, 0.382935198661, 0.377078814425, 0.371837256254, 0.367022663092, 0.362528606902,
    0.358287687980, 0.354253915376, 0.350394178456, 0.346683656682, 0.343103147348, 0.339637412755, 0.336274107417,
    0.333003053806, 0.329815737121, 0.326704942952, 0.323664491201, 0.320689036621, 0.317773916591, 0.314915033071,
    0.312108759781, 0.309351868267, 0.306641468351, 0.303974959672, 0.301349991871, 0.298764431605, 0.296216335010,
    0.293703924531, 0.291225569311, 0.288779768483, 0.286365136854, 0.283980392573, 0.281624346458, 0.279295892714,
    0.276994000820, 0.274717708424, 0.272466115072, 0.270238376681, 0.268033700632, 0.265851341400, 0.263690596665,
    0.261550803823, 0.259431336858, 0.257331603526, 0.255251042819, 0.253189122664, 0.251145337845, 0.249119208115,
    0.247110276469, 0.245118107582, 0.243142286368, 0.241182416675, 0.239238120076, 0.237309034763, 0.235394814533,
    0.233495127847, 0.231609656968, 0.229738097157, 0.227880155934, 0.226035552393, 0.224204016563, 0.222385288819,
    0.220579119327, 0.218785267535, 0.217003501692, 0.215233598403, 0.213475342210, 0.211728525204, 0.209992946655,
    0.208268412675, 0.206554735891, 0.204851735146, 0.203159235214, 0.201477066533, 0.199805064954, 0.198143071502,
    0.196490932156, 0.194848497634, 0.193215623197, 0.191592168459, 0.189977997207, 0.188372977238, 0.186776980193,
    0.185189881409, 0.183611559775, 0.182041897596, 0.180480780462, 0.178928097126, 0.177383739389, 0.175847601984,
    0.174319582478, 0.172799581163, 0.171287500964, 0.169783247348, 0.168286728237, 0.166797853923, 0.165316536988,
    0.163842692233, 0.162376236598, 0.160917089100, 0.159465170763, 0.158020404555, 0.156582715329, 0.155152029761,
    0.153728276302, 0.152311385115, 0.150901288034, 0.149497918506, 0.148101211553, 0.146711103719, 0.145327533033,
    0.143950438964, 0.142579762383, 0.141215445524, 0.139857431950, 0.138505666512, 0.137160095323, 0.135820665720,
    0.134487326233, 0.133160026560, 0.131838717532, 0.130523351090, 0.129213880255, 0.127910259104, 0.126612442748,
    0.125320387302, 0.124034049870, 0.122753388515, 0.121478362246, 0.120208930991, 0.118945055583, 0.117686697738,
    0.116433820038, 0.115186385913, 0.113944359626, 0.112707706257, 0.111476391687, 0.110250382582, 0.109029646381,
    0.107814151285, 0.106603866237, 0.105398760916, 0.104198805724, 0.103003971771, 0.101814230871, 0.100629555524,
    0.099449918913, 0.098275294890, 0.097105657972, 0.095940983326, 0.094781246768, 0.093626424752, 0.092476494361,
    0.091331433308, 0.090191219919, 0.089055833139, 0.087925252518, 0.086799458209, 0.085678430967, 0.084562152138,
    0.083450603662, 0.082343768069, 0.081241628471, 0.080144168566, 0.079051372635, 0.077963225537, 0.076879712714,
    0.075800820183, 0.074726534546, 0.073656842980, 0.072591733248, 0.071531193691, 0.070475213238, 0.069423781405,
    0.068376888298, 0.067334524618, 0.066296681666, 0.065263351344, 0.064234526165, 0.063210199258, 0.062190364374,
    0.061175015896, 0.060164148844, 0.059157758886, 0.058155842351, 0.057158396233, 0.056165418213, 0.055176906661,
    0.054192860658, 0.053213280009, 0.052238165257, 0.051267517705, 0.050301339431, 0.049339633309, 0.048382403036,
    0.047429653146, 0.046481389048, 0.045537617040, 0.044598344351, 0.043663579164, 0.042733330654, 0.041807609023,
    0.040886425542, 0.039969792593, 0.039057723715, 0.038150233653, 0.037247338412, 0.036349055318, 0.035455403080,
    0.034566401857, 0.033682073334, 0.032802440803, 0.031927529253, 0.031057365464, 0.030191978112, 0.029331397889,
    0.028475657623, 0.027624792423, 0.026778839829, 0.025937839982, 0.025101835814, 0.024270873251, 0.023445001448,
    0.022624273048, 0.021808744468, 0.020998476229, 0.020193533317, 0.019393985603, 0.018599908311, 0.017811382559,
    0.017028495976, 0.016251343413, 0.015480027772, 0.014714660966, 0.013955365052, 0.013202273572, 0.012455533140,
    0.011715305367, 0.010981769184, 0.010255123694, 0.009535591720, 0.008823424254, 0.008118906148, 0.007422363497,
    0.006734173424, 0.006054777338, 0.005384699393, 0.004724573037, 0.004075180742, 0.003437516439, 0.002812890105,
    0.002203118422, 0.001610916725, 0.001040868615, 0.000502780951
};

static inline float norm(float x)
{
    return 1 / sqrtf(2*M_PI) * expf(-1 * x*x / 2);
}

static inline float ziggurat_float(hpg_state *st)
{
    uint32_t c = 0;
    uint32_t d = 0;
    for (;;) {
        if (st->counter + 4 >= STATE_BUFFER_SIZE) {
            st->rng->bytes((uint8_t *)st->internal_rand_buffer, sizeof(st->internal_rand_buffer), st->rng->state);
            st->counter = 0;
        }
        float u1 = st->internal_rand_buffer[st->counter++];
        float u2 = st->internal_rand_buffer[st->counter++] * INV_UINT32_MAX;
        if (!c) {
            c = st->internal_rand_buffer[st->counter++];
        }
        if (!d) {
            d = st->internal_rand_buffer[st->counter++];
        }

        uint8_t select = c & 0xFF;
        c >>= 8;

        float x = u1 * zigg_w[select];
        if (d & 0x1) {
            x *= -1;
        }
        d >>= 1;

        if (u1 < zigg_k[select]) {
            return x*st->stddev;
        } else if (u2 * (zigg_f[select - 1] - zigg_f[select]) < norm(x) - zigg_f[select]) {
            return x*st->stddev;
        }

        if (select == 0) {
            float y = 0;
            do {
                if (st->counter + 2 >= STATE_BUFFER_SIZE) {
                    st->rng->bytes((uint8_t *)st->internal_rand_buffer, sizeof(st->internal_rand_buffer), st->rng->state);
                    st->counter = 0;
                }
                x = -logf(st->internal_rand_buffer[st->counter++] * INV_UINT32_MAX) * 0.2904764;
                y = -logf(st->internal_rand_buffer[st->counter++] * INV_UINT32_MAX);
            } while (y + y < x*x);

            return x*st->stddev;
        }
    }
}

bool hpg_initialize(float stddev, enum SamplerBackend sampler, rng_c *rng, hpg_state *state)
{
    if (!state || !rng || !rng->bytes || !rng->init || !rng->seed) {
        return false;
    }
    state->counter = STATE_BUFFER_SIZE;
    state->sampler = sampler;
    state->stddev = stddev;
    state->rng = rng;

    for (int i = 0; i < 256; ++i) { }

    return false;
}

bool hpg_sample_con_float(float *sample, hpg_state *state)
{
    if (!sample || !state) {
        return false;
    }

    if (state->counter >= STATE_BUFFER_SIZE) {
        state->rng->bytes((uint8_t *)state->internal_rand_buffer, sizeof(state->internal_rand_buffer), state->rng->state);
        state->counter = 0;
    }

    switch (state->sampler) {
    case InverseXForm:
        *sample = inv_xform_float(state->internal_rand_buffer[state->counter++], state->stddev);
        break;
    case AcceptanceRejection:
        *sample = accept_reject_float(state);
        break;
    case BoxMuller:
        *sample = box_muller_float(state);
        break;
    case Ziggurat:
        *sample = ziggurat_float(state);
        break;
    default:
        break;
    }

    return true;
}

bool hpg_sample_dis_float(float *sample, hpg_state *state)
{
    return false;
}
